#textdomain wesnoth-To_Lands_Unknown
[scenario]
    id=11_Mag-Magar
    next_scenario=12_A_New_Leader
    name= _ "Mag-Magar"
    map_data="{~add-ons/To_Lands_Unknown/maps/11_Mag_Magar.map}"
    turns=40
    victory_when_enemies_defeated=no

    {FIRST_WATCH}
    {SCENARIO_MUSIC siege_of_laurelmor.ogg}
    {EXTRA_SCENARIO_MUSIC vengeful.ogg}
    {EXTRA_SCENARIO_MUSIC casualties_of_war.ogg}

    [side]
        side=1
        controller=human
        team_name=mehirteam
        user_team_name= _ "team_name^Mehir"

        type=TLU_Grand_Summoner
        id=Mehir
        name= _ "Mehir"
        unrenamable=yes
        canrecruit=yes

        recruit=EoMa_Novice_Summoner,EoMa_Camel_Rider,EoMa_Carpet_Rider,EoMa_Water_Elemental,EoMa_Summoner,EoMa_Rhami,EoMa_Fire_Elemental

        {GOLD 400 300 200}
        {INCOME 10 5 2}
    [/side]

    [side]
        side=2
        controller=ai
        team_name=tharis
        user_team_name= _ "team_name^Unknown 1"
        color=brown

        type=EoMa_Matriarch_of_Emptiness
        id=Matriarch1
        generate_name=yes
        unrenamable=yes
        canrecruit=yes

        recruit=EoMa_Disciple,EoMa_Witch,EoMa_Dark_Warrior,EoMa_Hydra,EoMa_Dark_Hunter,EoMa_Bladedancer,EoMa_Dark_Wizard,EoMa_Dark_Witch,EoMa_Commander,EoMa_Dark_Slayer,EoMa_Raging_Hydra,EoMa_Great_Hunter,EoMa_Dark_Assassin,EoMa_Sworddancer

        [ai]
            passive_leader=yes
            aggression=1.0
            #recruitment_pattern=archer,archer,fighter,mixed fighter,mixed fighter,scout
        [/ai]

        {GOLD 100 250 400}
        {INCOME 0 5 7}

        {UNIT 2 (EoMa_Bladedancer) 38 17 (facing=sw)}
        {UNIT 2 (EoMa_Dark_Wizard) 40 18 (facing=sw)}
        {UNIT 2 (EoMa_Dark_Witch) 44 16 (facing=sw)}
        {UNIT 2 (EoMa_Disciple) 32 18 (facing=sw)}
        {UNIT 2 (EoMa_Witch) 30 17 (facing=sw)}
        {UNIT 2 (EoMa_Dark_Warrior) 27 18 (facing=sw)}
    [/side]

    [side]
        side=3
        controller=ai
        team_name=tharis
        user_team_name= _ "team_name^Unknown 2"
        color=purple

        type=EoMa_Cold_Matriarch
        id=Matriarch2
        generate_name=yes
        unrenamable=yes
        canrecruit=yes

        recruit=EoMa_Disciple,EoMa_Witch,EoMa_Dark_Warrior,EoMa_Hydra,EoMa_Dark_Hunter,EoMa_Bladedancer,EoMa_Dark_Wizard,EoMa_Dark_Witch,EoMa_Commander,EoMa_Dark_Slayer,EoMa_Raging_Hydra,EoMa_Great_Hunter,EoMa_Dark_Assassin,EoMa_Sworddancer

        [ai]
            passive_leader=yes
            aggression=1.0
            #recruitment_pattern=archer,archer,fighter,mixed fighter,mixed fighter,scout
        [/ai]

        {GOLD 100 250 400}
        {INCOME 0 5 7}
        {UNIT 3 (EoMa_Commander) 13 7 ()}
        {UNIT 3 (EoMa_Commander) 11 11 ()}
        {UNIT 3 (EoMa_Dark_Slayer) 19 16 ()}
        {UNIT 3 (EoMa_Hydra) 22 17 ()}
        {UNIT 3 (EoMa_Bladedancer) 25 16 (facing=sw)}
        {UNIT 3 (EoMa_Dark_Hunter) 22 14 (facing=sw)}
    [/side]

    [side]
        side=4
        controller=ai
        team_name=tharis
        user_team_name= _ "team_name^Unknown 3"
        color=black

        type=EoMa_Matriarch_of_Darkness
        id=Matriarch3
        generate_name=yes
        unrenamable=yes
        canrecruit=yes

        recruit=EoMa_Disciple,EoMa_Witch,EoMa_Dark_Warrior,EoMa_Hydra,EoMa_Dark_Hunter,EoMa_Bladedancer,EoMa_Dark_Wizard,EoMa_Dark_Witch,EoMa_Commander,EoMa_Dark_Slayer,EoMa_Raging_Hydra,EoMa_Great_Hunter,EoMa_Dark_Assassin,EoMa_Sworddancer

        [ai]
            passive_leader=yes
            aggression=1.0
            #recruitment_pattern=archer,archer,fighter,mixed fighter,mixed fighter,scout
        [/ai]

        {GOLD 100 250 400}
        {INCOME 0 5 7}
        {UNIT 4 (EoMa_Raging_Hydra) 36 12 ()}
        {UNIT 4 (EoMa_Great_Hunter) 39 13 (facing=sw)}
        {UNIT 4 (EoMa_Dark_Assassin) 37 11 ()}
        {UNIT 4 (EoMa_Chaos_Hydra) 36 9 (facing=sw)}
        {UNIT 4 (EoMa_General) 33 16 (facing=sw)}
        {UNIT 4 (EoMa_Dark_Wizard) 41 14 (facing=sw)}
    [/side]

    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "EoMa_Dark_Wizard" 3}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "EoMa_Dark_Wizard" 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "EoMa_Dark_Wizard" 1}

    [side]
        side=5
        controller=ai
        team_name=mehirteam
        user_team_name= _ "team_name^Army of Mag-Magar"
        color=orange

        type=EoMa_Summons_Master
        id=Malib
        name=Malib
        unrenamable=yes
        canrecruit=yes
        ai_special=guardian

        [ai]
            passive_leader=yes
            #Do not make these units suicidally aggressive, i.e. 1.0.  The player loses if the leader is killed,
            #and babysitting these units is annoying.  If Malib survives and protects, he's doing his job.
            aggression=0.0
            leader_aggression=0.0
            grouping=defensive
            #Too much caution makes units chicken out, retreat to the east, and never get into the fight.
            #Use the default caution.
            #Don't send units wandering off to grab villages.  They'll just get killed.
            village_value=0.0
            villages_per_scout=0
        [/ai]

        {GOLD 400 200 100}
        {INCOME 10 5 0}

        {UNIT 5 (EoMa_Dimensional_Gate_II) () () (placement=leader)}
        {UNIT 5 (EoMa_HoRhami) () () (placement=leader)}
        {UNIT 5 (EoMa_DharmaRhami) () () (placement=leader)}
        {UNIT 5 (EoMa_Dimensional_Gate_II) () () (placement=leader)}
        {UNIT 5 (EoMa_Dimensional_Gate_II) () () (placement=leader)}
        {UNIT 5 (EoMa_Mystical_Jinn) () () (placement=leader)}

        {UNIT 5 (EoMa_Dispeller) 28 18 ()}
        {UNIT 5 (EoMa_Dispeller) 30 18 ()}
        {UNIT 5 (EoMa_Novice_Summoner) 28 18 ()}
        {UNIT 5 (EoMa_Heavy_Summoner) 23 18 ()}
        {UNIT 5 (EoMa_Earth_Avatar) 26 16 ()}
    [/side]

    [event]
        name=prestart
        [recall]
            id=Rashti
        [/recall]
        {PLACE_HALO "scenery/white.png" 25 21}
    [/event]

    [event]
        name=turn 1
        {FADE_STEP 225 50}
        {REMOVE_IMAGE 25 21}
        {FADE_STEP 192 5}
        {FADE_STEP 160 5}
        {FADE_STEP 128 5}
        {FADE_STEP 96 5}
        {FADE_STEP 64 5}
        {FADE_STEP 32 5}
        {FADE_STEP 0 5}

        {VARIABLE witches 3}
        {VARIABLE illusion_active no}
        [store_unit]
            [filter]
                id=Malib
            [/filter]
            variable=malibvar
        [/store_unit]
        {VARIABLE malibvar.max_moves 0}
        {VARIABLE malibvar.moves 0}
        [unstore_unit]
            variable=malibvar
            find_vacant=no
        [/unstore_unit]
        {CLEAR_VARIABLE malibvar}
        {MODIFY_UNIT (type=EoMa_Dimensional_Gate_II,EoMa_DharmaRhami,EoMa_HoRhami,EoMa_Mystical_Jinn
        side=5) moves 0}
        {MODIFY_UNIT (type=EoMa_Dimensional_Gate_II,EoMa_DharmaRhami,EoMa_HoRhami,EoMa_Mystical_Jinn
        side=5) max_moves 0}
        [message]
            speaker=Malib
            message= _ "Thank Nomolas! Help at last! My army has been almost defeated by those creatures of darkness... wait, you don’t look like one of the leaders of the Trinity. Who are you?"
        [/message]
        [message]
            speaker=Mehir
            message= _ "My name is Mehir. I’m a Commander of the Second Degree. The Armies of the Trinity will arrive soon."
        [/message]
        [message]
            speaker=Malib
            message= _ "Excellent. I hope we will live long enough to see them. Unfortunately, I can’t risk fighting. My deputy was cut into pieces and this city mustn’t lose its leader."
        [/message]
        #Mehir doesn't like that deputies are always getting cut into pieces to save their leaders.
        #Mehir's response does not have to be strictly rational.  It develops his character.
        #How would you like it if some snarky leader said, "Sorry fellas, I know we're about to be
        #overrun but I won't fight, you'll have to do the dying for me." ?  Malib is just as
        #self-absorbed as Mehir: he says, "What difference does it make?"
        [message]
            speaker=Mehir
            message= _ "Your deputy, was he cut by a blade?"
        [/message]
        [message]
            speaker=Malib
            message=_ "What!? No, by horrible teeth. What difference does it make?"
        [/message]
        [message]
            speaker=Mehir
            message=_ "A great deal of difference, if I am to save you."
        [/message]
        {SCROLL_TO 25 21}
        [message]
            speaker=narrator
            image=halo/jinn-circle6.png
            message= _ "You can use the giant circle you are standing on in order to recruit or recall units."
        [/message]
        [objectives]
            side=1
            [objective]
                description= _ "Defeat all invaders"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Mehir"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Rashti"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Malib"
                condition=lose
            [/objective]

            {TURNS_RUN_OUT}
        [/objectives]
    [/event]

    #tower event
    [event]
        name=side 5 turn 4
        [message]
            speaker=Matriarch1
            message= _ "...ris..."
        [/message]
        [message]
            speaker=Matriarch2
            message= _ "...aris..."
        [/message]
        [message]
            speaker=Matriarch3
            message= _ "Tharis"
        [/message]

        [message]
            speaker=Mehir
            message= _ "Something’s wrong..."
        [/message]
        [delay]
            time=1000
        [/delay]
        [message]
            speaker=Malib
            message= _ "In Nomolas’s name!!!"
        [/message]
        {SCROLL_TO 25 16}
        {VARIABLE y_loc 1}
        [while]
            [variable]
                name=y_loc
                less_than_equal_to=17
            [/variable]
            [do]
                [item]
                    x=25
                    y=$y_loc
                    halo=scenery/tower-falling.png
                [/item]

                [delay]
                    time=15
                [/delay]

                {REMOVE_IMAGE 25 ($y_loc)}
                {VARIABLE_OP y_loc add 1}
            [/do]
        [/while]
        {CLEAR_VARIABLE y_loc}
        [sound]
            name=explosion.ogg
        [/sound]
        [sound]
            name=explosion.ogg
        [/sound]
        {PLACE_HALO "scenery/title-1.png" 25 15}
        [delay]
            time=3000
        [/delay]
        [terrain_mask]
            x,y=21,15
            mask="{~add-ons/To_Lands_Unknown/maps/11_Mag_Magar.mask}"
        [/terrain_mask]

        [store_unit]
            [filter]
                [filter_location]
                    #Watch out! If this terrain code doesn't exactly match,
                    #then units can get stuck in impassable terrain.
                    terrain=Xv
                [/filter_location]
            [/filter]
            variable=trapped
            kill=yes
        [/store_unit]

        [store_locations]
            #Do not store locations northwest of the tower.  That pocket is a deathtrap.
            #Keep a tight battle line facing the direction the enemy will be coming.
            #Do not overextend it into areas the enemy is probably holding.
            x,y=27,14
            radius=2
            [or]
                x,y=30,17
                radius=2
            [/or]
            [or]
                x,y=32,21
                radius=2
            [/or]
            [not]
                #Watch out! If this terrain code doesn't exactly match,
                #then units can get stuck in impassable terrain.
                terrain=Xv
            [/not]
            variable=freespace
        [/store_locations]

        {FOREACH trapped i}
            [unstore_unit]
                variable=trapped[$i]
                find_vacant=yes
                x,y=$freespace[$i].x,$freespace[$i].y
            [/unstore_unit]
        {NEXT i}

        {CLEAR_VARIABLE freespace}
        {CLEAR_VARIABLE trapped}

        {PLACE_HALO "scenery/tower-ruin.png" 25 19}
        {REMOVE_IMAGE 25 15}
        {FADE_IN}
        [message]
            speaker=Mehir
            message= _ "Good Nomolas! What was THAT?!"
        [/message]
        [message]
            speaker=Malib
            message= _ "The circle has been destroyed! We’ve lost contact with the capital. Reinforcements won’t arrive for weeks! We’re lost..."
        [/message]
        [message]
            speaker=Mehir
            message= _ "Now every single blade is important. We must kill these witches — it may be our only chance to stop the invaders."
        [/message]
        [message]
            speaker=Malib
            message= _ "May Nomolas grant that.

Now it’s all the same for me. I prefer dying in battle than staying here, so..."
        [/message]
        [message]
            speaker=Malib
            message=_ "At them! NOMOLAS IS GREAT!!!"
        [/message]
        [modify_side]
            side=5
            [ai]
                passive_leader=no
                #Without a [leader_goal], Malib will turn into a big chicken, running to the east and leaving
                #friendly units high and dry.
                [leader_goal]
                    #This hex has an impassable flank.  Minimizes Malib's exposure while still being offensive.
                    x,y=37,22
                [/leader_goal]
            [/ai]
        [/modify_side]
        #Afterwards, try to reach Mehir every turn.
        [event]
            name=side 5 turn
            first_time_only=no
            [store_unit]
                [filter]
                    id=Mehir
                [/filter]
                variable=mehirloc
            [/store_unit]
            [modify_side]
                side=5
                [ai]
                    [leader_goal]
                        x,y=$mehirloc.x,$mehirloc.y
                    [/leader_goal]
                [/ai]
            [/modify_side]
            {CLEAR_VARIABLE mehirloc}
        [/event]
        {MODIFY_UNIT (id=Malib) moves 5}
        {MODIFY_UNIT (type=EoMa_Dimensional_Gate_II
        side=5) moves 8}
        {MODIFY_UNIT (type=EoMa_Mystical_Jinn
        side=5) moves 8}
        {MODIFY_UNIT (type=EoMa_DharmaRhami
        side=5) moves 5}
        {MODIFY_UNIT (type=EoMa_HoRhami
        side=5) moves 5}
        {MODIFY_UNIT (id=Malib) max_moves 5}
        {MODIFY_UNIT (type=EoMa_Dimensional_Gate_II
        side=5) max_moves 8}
        {MODIFY_UNIT (type=EoMa_Mystical_Jinn
        side=5) max_moves 8}
        {MODIFY_UNIT (type=EoMa_DharmaRhami
        side=5) max_moves 5}
        {MODIFY_UNIT (type=EoMa_HoRhami
        side=5) max_moves 5}
    [/event]

    [event]
        name=last breath
        #first_time_only=no
        [filter]
            id=Matriarch1
            [or]
                id=Matriarch2
            [/or]
            [or]
                id=Matriarch3
            [/or]
        [/filter]

        #{VARIABLE_OP witches sub 1}
        [if]
            [variable]
                name=turn_number
                less_than=10
            [/variable]
            [and]
                [variable]
                    name=witches
                    equals=3
                [/variable]
            [/and]
            [then]
                [fire_event]
                    name=turn 10
                    [primary_unit]
                        id=Matriarch1
                        [or]
                            id=Matriarch2
                        [/or]
                        [or]
                            id=Matriarch3
                        [/or]
                    [/primary_unit]
                [/fire_event]
            [/then]
        [/if]
    [/event]

    #witches counter
    [event]
        name=die
        first_time_only=no
        [filter]
            id=Matriarch1
            [or]
                id=Matriarch2
            [/or]
            [or]
                id=Matriarch3
            [/or]
        [/filter]

        {VARIABLE_OP witches sub 1}

        [if]
            [variable]
                name=witches
                equals=1
            [/variable]
            [then]
                [kill]
                    id=$unit.id
                    animate=no
                [/kill]
                #illusion starts
                [fire_event]
                    name=illusion
                [/fire_event]
            [/then]
        [/if]
    [/event]

    #teleport effect
    [event]
        name=prerecruit, prerecall
        first_time_only=no

        [filter]
            side=1
        [/filter]

        {FAKE_SCENERY_ANIM scenery/circle-magmagar 11 25 15 5}
        {PLACE_HALO "scenery/circle-magmagar-11.png" 25 15}
    [/event]
    [event]
        name=recruit, recall
        first_time_only=no

        [filter]
            side=1
        [/filter]

        {REVERSE_SCENERY_ANIM scenery/circle-magmagar 11 25 15 5}
    [/event]

    [event]
        name=die
        [filter]
            id=Malib
        [/filter]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    [event]
        name=illusion

        {VARIABLE illusion_active yes}
        {FADE_TO_BLACK}
        [color_adjust]
            red,green,blue=-255,-255,-255
        [/color_adjust]
        [delay]
            time=2000
        [/delay]
        [message]
            speaker=Mehir
            message= _ "Hey, what’s going on? Everything is disappearing..."
        [/message]
        [store_unit]
            [filter]
                id=Rashti
            [/filter]
            variable=rashti
            kill=yes
        [/store_unit]
        [store_unit]
            [filter]
                side=1,5
                [not]
                    id=Mehir
                [/not]
                [not]
                    id=Malib
                [/not]
                [not]
                    x,y=recall,recall
                [/not]
            [/filter]
            variable=illusion
            kill=yes
        [/store_unit]
        [store_unit]
            [filter]
                [not]
                    id=Mehir
                [/not]
                [not]
                    id=Malib
                [/not]
            [/filter]
            variable=illusion2
            kill=yes
        [/store_unit]
        [store_unit]
            [filter]
                id=Malib
            [/filter]
            variable=malibvar
            kill=yes
        [/store_unit]
        [message]
            speaker=Mehir
            message= _ "Hello, is there anybody around here?"
        [/message]
        [delay]
            time=1000
        [/delay]
        [if]
            [variable]
                name=illusion.length
                less_than=3
            [/variable]
            [then]
                {VARIABLE counter_limit $illusion.length}
            [/then]
            [else]
                {VARIABLE counter_limit 3}
            [/else]
        [/if]
        #find 3 units with the lowest hitpoints
        {VARIABLE hp_value 1}
        {VARIABLE hp_counter 0}
        {VARIABLE stop_wheel 0}

        {REPEAT ($illusion.length) (
            [if]
                [variable]
                    name=stop_wheel
                    equals=0
                [/variable]
                [then]
                    {FOREACH illusion i}
                        [if]
                            [variable]
                                name=illusion[$i].hitpoints
                                equals=$hp_value
                            [/variable]
                            [then]
                                [set_variables]
                                    name=hp_unit
                                    mode=append
                                    [value]
                                        value=$i
                                    [/value]
                                [/set_variables]
                                {VARIABLE_OP hp_counter add 1}
                                [if]
                                    [variable]
                                        name=hp_counter
                                        equals=3
                                    [/variable]
                                    [then]
                                        {VARIABLE stop_wheel 1}
                                    [/then]
                                [/if]
                            [/then]
                        [/if]
                    {NEXT i}
                [/then]
            [/if]
            {VARIABLE_OP hp_value add 1}
            [if]
                [variable]
                    name=hp_value
                    equals=99
                [/variable]
                [then]
                    {VARIABLE stop_wheel 1}
                [/then]
            [/if]
        )}
        [fire_event]
            name=illusion2
        [/fire_event]
    [/event]

    [event]
        name=illusion2
        first_time_only=no
        [if]
            [variable]
                name=illusion.length
                greater_than=0
            [/variable]
            [then]
                {UNIT 2 (EoMa_Matriarch_of_Darkness) ($illusion[$hp_unit[$counter].value].x) ($illusion[$hp_unit[$counter].value].y) (hitpoints=1
                id=matriarch4)}

                {SCROLL_TO ($illusion[$hp_unit[$counter].value].x) ($illusion[$hp_unit[$counter].value].y)}
                #{CLEAR_VARIABLE illusion[$counter]}
                {VARIABLE illusion[$hp_unit[$counter].value].hitpoints 1}
                {MODIFY_UNIT id=matriarch4 moves 0}
                {MODIFY_UNIT id=matriarch4 max_moves 0}
                {MODIFY_UNIT id=matriarch4 attack[0].attack_weight 0}
                {MODIFY_UNIT id=matriarch4 attack[1].attack_weight 0}
                {MODIFY_UNIT id=matriarch4 attack[2].attack_weight 0}
                {MODIFY_UNIT id=matriarch4 attack[0].defense_weight 0}
                {MODIFY_UNIT id=matriarch4 attack[1].defense_weight 0}
                {MODIFY_UNIT id=matriarch4 attack[2].defense_weight 0}
                {VARIABLE_OP counter add 1}
            [/then]
            [else]
                [fire_event]
                    name=bakhaevent
                [/fire_event]
            [/else]
        [/if]
    [/event]

    #disable illusion healing
    [event]
        name=attack
        first_time_only=no
        [filter_second]
            id=matriarch4
        [/filter_second]
        {VARIABLE second_unit.hitpoints 1}
        [unstore_unit]
            variable=second_unit
            find_vacant=no
        [/unstore_unit]
    [/event]

    #execute next illusion
    [event]
        name=die
        first_time_only=no
        [filter]
            id=matriarch4
        [/filter]
        [if]
            [variable]
                name=counter
                equals=$counter_limit
            [/variable]
            [then]
                [kill]
                    id=matriarch4
                    animate=no
                [/kill]
                [delay]
                    time=1000
                [/delay]
                [fire_event]
                    name=bakhaevent
                [/fire_event]
            [/then]
            [else]
                [message]
                    speaker=unit
                    message= _ "Hahahaaahaaaaaaaaaa!!!"
                [/message]
                [kill]
                    id=matriarch4
                    animate=no
                [/kill]
                [fire_event]
                    name=illusion2
                [/fire_event]
            [/else]
        [/if]
    [/event]

    [event]
        name=bakhaevent
        [store_unit]
            [filter]
                id=Mehir
            [/filter]
            variable=mehir_illusion
        [/store_unit]
        {FOREACH illusion_memory i}
            [unstore_unit]
                variable=illusion_memory[$i]
                find_vacant=yes
                x,y=$mehir_illusion.x,$mehir_illusion.y
            [/unstore_unit]
        {NEXT i}
        {CLEAR_VARIABLE mehir_illusion}
        [message]
            speaker=Mehir
            message= _ "Who... who are you?"
        [/message]
        [message]
            speaker=Bakha
            message= _ "Don’t you recognize us?"
        [/message]
        [message]
            speaker=Mehir
            message= _ "You look familiar..."
        [/message]
        [message]
            speaker=Bakha
            message= _ "You stupid cloth! We are the ones who died for you!"
        [/message]
        [message]
            speaker=Mehir
            message= _ "Oh my... You’re my lost soldiers! It’s impossible..."
        [/message]
        [message]
            speaker=Bakha
            message= _ "You fool, Because of you we will never see the Abyss!"
        [/message]
        [message]
            speaker=Mehir
            message= _ "I... I am so sorry... Please, understand..."
        [/message]
        [message]
            speaker=Bakha
            message= _ "Sorry? Is this all you have to say? How dare you... KILL HIM!!!"
        [/message]
        [message]
            speaker=Mehir
            message= _ "Please, NOOO!!!"
        [/message]
        [store_unit]
            [filter]
                id=Bakha
            [/filter]
            variable=bakha
        [/store_unit]
        {TRANSFORM_UNIT id=Bakha (EoMa_Matriarch_of_Darkness)}
        [kill]
            side=1
            [not]
                id=Mehir
            [/not]
            [not]
                id=Bakha
            [/not]
            animate=no
        [/kill]
        {CLEAR_VARIABLE illusion_memory}
        [unstore_unit]
            variable=rashti
            find_vacant=yes
            x,y=$bakha.x,$bakha.y
        [/unstore_unit]
        [kill]
            type=EoMa_Matriarch_of_Darkness
            animate=yes
        [/kill]

        [message]
            speaker=Rashti
            image="portraits/rashti-ho.png"
            message= _ "Mehir, it’s all gone. You’re safe now."
        [/message]

        {FOREACH illusion i}
            [if]
                [variable]
                    name=illusion[$i].canrecruit
                    equals=yes
                [/variable]
                [else]
                    [unstore_unit]
                        variable=illusion[$i]
                        find_vacant=yes
                    [/unstore_unit]
                [/else]
            [/if]
        {NEXT i}
        {FOREACH illusion2 i}
            [unstore_unit]
                variable=illusion2[$i]
                find_vacant=yes
            [/unstore_unit]
        {NEXT i}
        [unstore_unit]
            variable=malibvar
            find_vacant=yes
        [/unstore_unit]

        {VARIABLE illusion 0}
        {FADE_IN}
        [message]
            speaker=Mehir
            message= _ "I... What happened? Am I alive?"
        [/message]
        [message]
            speaker=Malib
            message= _ "These witches have cast a spell on you. You flew into a fury and started killing our men. We are lucky that holy Rashti’rhami has killed the witch and stopped your madness..."
        [/message]
        [message]
            speaker=Mehir
            message= _ "I thought I was killing witches, but they were my own men. It was terrible...."
        [/message]
        [message]
            speaker=Malib
            message= _ "There’s no time for talk. These sons of Efreeti won’t give up. We must kill them all.."
        [/message]
        {CLEAR_VARIABLE bakha}
        {CLEAR_VARIABLE rashti}
        {CLEAR_VARIABLE illusion}
        {CLEAR_VARIABLE illusion_active}
        {CLEAR_VARIABLE malibvar}
    [/event]

    [event]
        name=side turn
        first_time_only=no
        [if]
            [variable]
                name=illusion_active
                boolean_equals=yes
            [/variable]
            [then]
                #Illusion turns should not count towards the turn limit, because Mehir may
                #have to walk very very far, and Rashti may get transported to the other side
                #of the map when the illusion ends.  Implement this by extending the turn limit.
                [modify_turns]
                    add=1
                [/modify_turns]
                [color_adjust]
                    red,green,blue=-255,-255,-255
                [/color_adjust]
            [/then]
        [/if]
    [/event]

    [event]
        name=die
        first_time_only=no
        [filter]
            side=2,3,4
        [/filter]
        [if]
            [have_unit]
                side=2,3,4
            [/have_unit]
            [then]
            [/then]
            [else]
                [endlevel]
                    result=victory
                [/endlevel]
            [/else]
        [/if]
    [/event]

    [event]
        name=victory
        [message]
            speaker=Malib
            message= _ "WE DID IT!!! Mehir, you’re my hero!"
        [/message]
        [message]
            speaker=Mehir
            message= _ "Indeed, we have defended the city."
        [/message]
        [message]
            speaker=Malib
            message=_ "I am infinitely grateful to you. Without your help... as soon as the first carpets arrive from al-Kamija, I’ll go and speak with the Highest Council. Your achievements shall be announced in the whole country!"
        [/message]
    [/event]

    [event]
        name=die
        [filter]
            id=Matriarch1
        [/filter]
        [terrain]
            x,y=47,14
            terrain=Rp
        [/terrain]
    [/event]
    [event]
        name=die
        [filter]
            id=Matriarch2
        [/filter]
        [terrain]
            x,y=8,6
            terrain=Rp
        [/terrain]
    [/event]
    [event]
        name=die
        [filter]
            id=Matriarch3
        [/filter]
        [terrain]
            x,y=35,9
            terrain=Rp
        [/terrain]
    [/event]

    #Malib summons
    [event]
        name=side 5 turn refresh
        first_time_only=no

        [if]
            [have_location]
                [filter]
                    id=Malib
                [/filter]
                radius=1
                [filter_adjacent_location]
                    [not]
                        [filter]
                        [/filter]
                    [/not]
                [/filter_adjacent_location]
            [/have_location]
            [then]
                [store_unit]
                    variable=malibvar2
                    [filter]
                        id=Malib
                        [filter_location]
                            terrain=Dd^Vda
                        [/filter_location]
                    [/filter]
                [/store_unit]
                {RANDOM 1..5}
                [switch]
                    variable=random
                    [case]
                        value=1
                        [unit]
                            type=EoMa_Fire_Elemental
                            side=5
                            x,y=$malibvar2.x,$malibvar2.y
                            moves=0
                            animate=yes
                        [/unit]
                    [/case]
                    [case]
                        value=2
                        [unit]
                            type=EoMa_Water_Elemental
                            side=5
                            x,y=$malibvar2.x,$malibvar2.y
                            moves=0
                            animate=yes
                        [/unit]
                    [/case]
                    [case]
                        value=3
                        [unit]
                            type=EoMa_Air_Elemental
                            side=5
                            x,y=$malibvar2.x,$malibvar2.y
                            moves=0
                            animate=yes
                        [/unit]
                    [/case]
                    [case]
                        value=4
                        [unit]
                            type=EoMa_Earth_Elemental
                            side=5
                            x,y=$malibvar2.x,$malibvar2.y
                            moves=0
                            animate=yes
                        [/unit]
                    [/case]
                    [case]
                        value=5
                        [unit]
                            type=EoMa_Rhami
                            side=5
                            x,y=$malibvar2.x,$malibvar2.y
                            moves=0
                            animate=yes
                        [/unit]
                    [/case]
                [/switch]
            [/then]
        [/if]
        {CLEAR_VARIABLE malibvar2}
    [/event]

    {ITEM_APPLIER}
    {SUMMONER_LOCK}
    {COLLAR_EVENT}
    {DEATH_MEHIR}
    {DEATH_RASHTI}
    {I8M11_TERRAIN}
[/scenario]
